# Container Image Publishing Workflow - TEST VERSION
#
# This is a TEMPORARY test workflow to validate changes before merging.
# DO NOT MERGE THIS FILE - it's for PR testing only.
#
# This workflow builds and publishes the model-registry server container image
# following modern supply chain security best practices per GitHub issue #1868.
#
# Key features:
# - Multi-architecture builds: linux/arm64, linux/amd64
# - SBOM generation using Anchore (SPDX format)
# - Keyless image signing using Cosign with GitHub OIDC
# - SBOM attestation cryptographically linked to image
# - SLSA provenance attestation (mode=max)
# - Automated tagging using docker/metadata-action
#
# Verification commands:
#   Verify signature:    cosign verify --certificate-identity-regexp=github --certificate-oidc-issuer=https://token.actions.githubusercontent.com ghcr.io/YOUR_USERNAME/model-registry/server:TAG
#   Verify SBOM attest:  cosign verify-attestation --type spdx --certificate-identity-regexp=github --certificate-oidc-issuer=https://token.actions.githubusercontent.com ghcr.io/YOUR_USERNAME/model-registry/server:TAG
#   Download SBOM:       cosign download attestation --predicate-type=https://spdx.dev/Document ghcr.io/YOUR_USERNAME/model-registry/server:TAG
#   Verify provenance:   cosign verify-attestation --type slsaprovenance --certificate-identity-regexp=github --certificate-oidc-issuer=https://token.actions.githubusercontent.com ghcr.io/YOUR_USERNAME/model-registry/server:TAG

name: Container image build and tag (TEST)
on:
  push:
    branches:
      - 'chore/1868-modernize-container-image-publishing'  # YOUR TEST BRANCH
  workflow_dispatch:  # Allows manual triggering from GitHub UI
env:
  IMG_REGISTRY: ghcr.io
  IMG_ORG: ${{ github.repository_owner }}  # Uses YOUR username instead of kubeflow
  IMG_REPO: model-registry/server
  DOCKER_USER: ${{ github.actor }}
  DOCKER_PWD: ${{ secrets.GITHUB_TOKEN }}

permissions: # set contents: read at top-level, per OpenSSF ScoreCard rule TokenPermissionsID
  contents: read

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Dummy prepare step
        run: echo "Prepare step placeholder - no actual prepare workflow in test"
  build-image:
    permissions:
      actions: read # anchore/sbom-action for syft
      contents: write # anchore/sbom-action for syft
      packages: write # push to ghcr.io
      id-token: write # keyless signing with cosign
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: prepare
    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v5.0.0

      # Set up QEMU for multi-architecture builds
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3.7.0

      # Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.11.1

      # Log in to the Container registry
      - name: Log in to the Container registry
        uses: docker/login-action@v3.6.0
        with:
          registry: ${{ env.IMG_REGISTRY }}
          username: ${{ env.DOCKER_USER }}
          password: ${{ env.DOCKER_PWD }}

      # Set version for SBOM filename compatibility
      - name: Set version environment
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            commit_sha=${{ github.sha }}
            echo "VERSION=main-${commit_sha:0:7}" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "VERSION=${{ github.ref_name }}" >> $GITHUB_ENV
          else
            # Fallback for PRs and other branches
            commit_sha=${{ github.sha }}
            echo "VERSION=test-${commit_sha:0:7}" >> $GITHUB_ENV
          fi

      # Extract metadata (tags, labels) for Docker
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5.9.0
        with:
          images: "${{ env.IMG_REGISTRY }}/${{ env.IMG_ORG }}/${{ env.IMG_REPO }}"
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=test-,format=short
            type=raw,value=test-latest

      # Build and push Docker image with multi-arch support
      - name: Build and push Docker image
        id: build-push
        uses: docker/build-push-action@v6.18.0
        with:
          context: .
          platforms: linux/arm64,linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: mode=max
          sbom: false # Using Anchore for SBOM generation instead to avoid duplication

      # Generate SBOM using Anchore (SPDX format for attestation)
      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: "${{ env.IMG_REGISTRY }}/${{ env.IMG_ORG }}/${{ env.IMG_REPO }}:${{ env.VERSION }}"
          format: spdx-json
          artifact-name: "model-registry-server-${{ env.VERSION }}-sbom.spdx.json"
          output-file: "model-registry-server-${{ env.VERSION }}-sbom.spdx.json"

      # Install Cosign for signing and attestation
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.10.1

      # Sign the container image (keyless signing using GitHub OIDC)
      - name: Sign container image
        env:
          DIGEST: ${{ steps.build-push.outputs.digest }}
        run: |
          if [[ -z "${DIGEST}" ]]; then
            echo "::error::Image digest is empty, cannot sign image"
            exit 1
          fi
          cosign sign --yes "${{ env.IMG_REGISTRY }}/${{ env.IMG_ORG }}/${{ env.IMG_REPO }}@${DIGEST}"

      # Attest SBOM to image (cryptographically linked attestation)
      - name: Attest SBOM to image
        env:
          DIGEST: ${{ steps.build-push.outputs.digest }}
        run: |
          if [[ -z "${DIGEST}" ]]; then
            echo "::error::Image digest is empty, cannot attest SBOM"
            exit 1
          fi
          if [[ ! -f "model-registry-server-${{ env.VERSION }}-sbom.spdx.json" ]]; then
            echo "::error::SBOM file not found: model-registry-server-${{ env.VERSION }}-sbom.spdx.json"
            exit 1
          fi
          cosign attest --yes \
            --type spdx \
            --predicate "model-registry-server-${{ env.VERSION }}-sbom.spdx.json" \
            "${{ env.IMG_REGISTRY }}/${{ env.IMG_ORG }}/${{ env.IMG_REPO }}@${DIGEST}"

      # Print verification instructions
      - name: Print verification instructions
        env:
          DIGEST: ${{ steps.build-push.outputs.digest }}
        run: |
          echo "::notice::Image built and signed successfully!"
          echo "::notice::Image: ${{ env.IMG_REGISTRY }}/${{ env.IMG_ORG }}/${{ env.IMG_REPO }}@${DIGEST}"
          echo ""
          echo "Verification commands:"
          echo "  Verify signature:"
          echo "    cosign verify --certificate-identity-regexp=github --certificate-oidc-issuer=https://token.actions.githubusercontent.com ${{ env.IMG_REGISTRY }}/${{ env.IMG_ORG }}/${{ env.IMG_REPO }}:${{ env.VERSION }}"
          echo ""
          echo "  Verify SBOM attestation:"
          echo "    cosign verify-attestation --type spdx --certificate-identity-regexp=github --certificate-oidc-issuer=https://token.actions.githubusercontent.com ${{ env.IMG_REGISTRY }}/${{ env.IMG_ORG }}/${{ env.IMG_REPO }}:${{ env.VERSION }}"
          echo ""
          echo "  Download SBOM:"
          echo "    cosign download attestation --predicate-type=https://spdx.dev/Document ${{ env.IMG_REGISTRY }}/${{ env.IMG_ORG }}/${{ env.IMG_REPO }}:${{ env.VERSION }}"
          echo ""
          echo "  Verify provenance:"
          echo "    cosign verify-attestation --type slsaprovenance --certificate-identity-regexp=github --certificate-oidc-issuer=https://token.actions.githubusercontent.com ${{ env.IMG_REGISTRY }}/${{ env.IMG_ORG }}/${{ env.IMG_REPO }}:${{ env.VERSION }}"
